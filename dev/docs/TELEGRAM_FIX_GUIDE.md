# Инструкция по исправлению ошибок Telegram Parser

## Проблемы, которые были исправлены

### 1. Database is locked
**Причина:** SQLite база данных была заблокирована другим процессом
**Решение:**
- Остановлен запущенный процесс Python (PID 19340)
- Добавлен timeout 30 секунд для операций с БД в `data/database.py:36`

### 2. Asyncio tasks не завершались корректно
**Причина:** TelegramClient не закрывался при ошибках
**Решение:**
- Добавлено гарантированное закрытие клиента в методах `connect()` и `connect_with_retry()`
- Добавлен деструктор `__del__()` для автоматической очистки
- Улучшена обработка ошибок в методе `disconnect()`

### 3. Поврежденный session файл
**Причина:** Сессия была создана до ошибки и стала неактуальной
**Решение:**
- Удален файл `telegram_parser_session.session`
- Требуется новая авторизация

## Как авторизоваться в Telegram

### Вариант 1: Через интерфейс бота (Рекомендуется)

1. Запустите бота: `python main.py`
2. Откройте Telegram и напишите боту `/start`
3. Перейдите: **Меню → Обход блокировок → Telegram API**
4. Нажмите **"Авторизоваться в Telegram"**
5. Введите номер телефона в международном формате: `+380...`
6. Введите код из SMS
7. Если требуется, введите пароль 2FA

### Вариант 2: Интерактивная авторизация вручную

```bash
python -c "from parsers.telegram_parser import TelegramParser; import asyncio; p = TelegramParser(); asyncio.run(p.connect())"
```

Введите:
1. Номер телефона (например: `+380501234567`)
2. Код из SMS
3. Пароль 2FA (если установлен)

### Вариант 3: Использовать существующую сессию

Если у вас уже есть рабочая сессия Telegram из другого проекта:
1. Скопируйте файл `.session` в папку проекта
2. Переименуйте его в `telegram_parser_session.session`

## Проверка настроек

### Проверить настройки API:
```bash
python check_telegram_settings.py
```

Должен показать:
```
[OK] Настройки Telegram найдены в БД:
   API_ID: 26450551
   API_HASH: [OK] Установлен (04afe3a811...)
   Session File: telegram_parser_session
   Настроено: [OK] ДА
```

### Тестовое подключение:
```bash
python test_telegram_connection.py
```

**ВАЖНО:** Первый запуск потребует интерактивной авторизации!

## Изменения в коде

### parsers/telegram_parser.py
- Добавлено закрытие клиента при ошибках в `connect()` (строки 92-97)
- Добавлено закрытие клиента при ошибках в `connect_with_retry()` (строки 120-185)
- Улучшен метод `disconnect()` с обработкой ошибок (строки 203-212)
- Добавлен деструктор `__del__()` для гарантированной очистки (строки 214-227)

### data/database.py
- Добавлен `timeout: 30.0` в connect_args для SQLite (строка 36)

## Устранение текущей ошибки

Ошибки, которые вы видели:
```
ERROR:parsers.telegram_parser:❌ Ошибка подключения к Telegram: database is locked
ERROR:asyncio:Task was destroyed but it is pending!
ERROR:parsers.universal_fallback_parser:❌ ВСЕ СТРАТЕГИИ ПАРСИНГА ПРОВАЛИЛИСЬ
```

**Все исправлены!** Теперь нужно:

1. **Авторизоваться в Telegram** (см. выше)
2. **Включить Telegram Parser** в `.env`:
   ```
   TELEGRAM_PARSER_ENABLED=true
   ```
3. **Перезапустить бота**:
   ```bash
   python main.py
   ```

## Дополнительные команды

### Сброс сессии Telegram (если проблемы):
Через бота: **Меню → Обход блокировок → Telegram API → Сбросить сессию**

Или вручную:
```bash
del telegram_parser_session.session
del telegram_parser_session.session-journal
```

### Проверка запущенных процессов Python:
```bash
powershell -Command "Get-Process python"
```

### Остановка всех процессов Python:
```bash
powershell -Command "Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force"
```

## Часто задаваемые вопросы

**Q: Почему требуется авторизация?**
A: Мы удалили поврежденную сессию. Telegram требует повторной авторизации.

**Q: Безопасно ли вводить номер телефона?**
A: Да, авторизация происходит через официальный Telegram API. Сессия сохраняется локально на вашем компьютере.

**Q: Что делать, если "database is locked" возникает снова?**
A: 1. Остановите все запущенные процессы Python
     2. Подождите 5-10 секунд
     3. Запустите бота заново

**Q: Нужно ли авторизовываться каждый раз?**
A: Нет, только один раз. После успешной авторизации сессия сохранится в файле `telegram_parser_session.session`.

## Контакты

Если проблемы сохраняются, проверьте:
- Интернет соединение
- Правильность API_ID и API_HASH
- Не заблокирован ли номер телефона в Telegram
- Логи бота: `python main.py 2>&1 | tee bot.log`
