# Circuit Breaker –¥–ª—è PriceFetcher

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç–µ–π–∫–∏–Ω–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Gate.io —Å 800+ –º–æ–Ω–µ—Ç–∞–º–∏) –±–æ—Ç —Ç—Ä–∞—Ç–∏—Ç **10+ –º–∏–Ω—É—Ç** –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã —Ü–µ–Ω —Ç–æ–∫–µ–Ω–æ–≤ –∫ CoinGecko –∏ CoinMarketCap API.

–ü—Ä–æ–±–ª–µ–º–∞ —É—Å—É–≥—É–±–ª—è–µ—Ç—Å—è —Ç–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ API –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç **429 Too Many Requests**, –Ω–æ –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ü–µ–Ω—ã –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å–æ—Ç–µ–Ω –º–æ–Ω–µ—Ç, –ø–æ–ª—É—á–∞—è —Ç–µ –∂–µ –æ—à–∏–±–∫–∏.

## –†–µ—à–µ–Ω–∏–µ: Circuit Breaker

–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º **Circuit Breaker** –≤ `utils/price_fetcher.py`:

### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–°—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ 429**: –ü—Ä–∏ –∫–∞–∂–¥–æ–π –æ—à–∏–±–∫–µ 429 (rate limit) —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å—á–µ—Ç—á–∏–∫
2. **–ü–æ—Ä–æ–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏**: –ü–æ—Å–ª–µ **5 –æ—à–∏–±–æ–∫ 429** circuit breaker –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
3. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤**: –í—Å–µ –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã —Ü–µ–Ω **–ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è** (–≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `None`)
4. **–°–±—Ä–æ—Å**: Circuit breaker **—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è** –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –Ω–æ–≤—ã–º –ø–∞—Ä—Å–∏–Ω–≥–æ–º

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

‚úÖ **–£—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞**: –í–º–µ—Å—Ç–æ 10+ –º–∏–Ω—É—Ç ‚Üí **~30 —Å–µ–∫—É–Ω–¥**
‚úÖ **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏**: –ú–µ–Ω—å—à–µ –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏**: –°—Ç–µ–π–∫–∏–Ω–≥–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (–ø—Ä–æ—Å—Ç–æ –±–µ–∑ USD —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–æ–≤)

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. `utils/price_fetcher.py`

```python
class PriceFetcher:
    def __init__(self, cmc_api_key: Optional[str] = None):
        # ...
        # Circuit breaker –¥–ª—è rate limiting
        self._rate_limit_hits = 0  # –°—á–µ—Ç—á–∏–∫ 429 –æ—à–∏–±–æ–∫
        self._circuit_open = False  # –§–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
        self.rate_limit_threshold = 5  # –ü–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫ - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º

    def get_token_price(self, symbol: str) -> Optional[float]:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º circuit breaker
        if self._circuit_open:
            logger.debug(f"‚ö° Circuit breaker –∞–∫—Ç–∏–≤–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã –¥–ª—è {symbol}")
            return None
        # ...

    def _handle_rate_limit(self, source: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ rate limit (429 –æ—à–∏–±–∫–∞)"""
        self._rate_limit_hits += 1
        logger.warning(f"‚ö†Ô∏è Rate limit hit #{self._rate_limit_hits} from {source}")

        if self._rate_limit_hits >= self.rate_limit_threshold:
            self._circuit_open = True
            logger.error(
                f"üö® CIRCUIT BREAKER –ê–ö–¢–ò–í–ò–†–û–í–ê–ù! "
                f"–ü–æ–ª—É—á–µ–Ω–æ {self._rate_limit_hits} –æ—à–∏–±–æ–∫ 429. "
                f"–ó–∞–ø—Ä–æ—Å—ã —Ü–µ–Ω –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–æ –∫–æ–Ω—Ü–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞."
            )

    def reset_circuit_breaker(self):
        """–°–±—Ä–æ—Å–∏—Ç—å circuit breaker (–¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞)"""
        if self._circuit_open:
            logger.info("üîÑ Circuit breaker —Å–±—Ä–æ—à–µ–Ω")
        self._rate_limit_hits = 0
        self._circuit_open = False
```

### 2. `bot/parser_service.py`

```python
# –°–æ–∑–¥–∞–µ–º –ø–∞—Ä—Å–µ—Ä —Å—Ç–µ–π–∫–∏–Ω–≥–æ–≤
parser = StakingParser(api_url=api_url, exchange_name=exchange_name)

# –°–±—Ä–∞—Å—ã–≤–∞–µ–º circuit breaker –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º
parser.price_fetcher.reset_circuit_breaker()

# –ü–∞—Ä—Å–∏–º —Å—Ç–µ–π–∫–∏–Ω–≥–∏
stakings = parser.parse()
```

## –õ–æ–≥–∏

### –î–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:

```
üì° –ó–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã USDT —Å CoinMarketCap...
‚úÖ –¶–µ–Ω–∞ USDT (CMC): $1.0
üì° –ó–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã BTC —Å CoinMarketCap...
‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ CMC –¥–ª—è BTC: 429 Client Error: Too Many Requests
‚ö†Ô∏è Rate limit hit #1 from CoinMarketCap
üì° –ó–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã BTC —Å CoinGecko...
‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ CoinGecko –¥–ª—è BTC: 429 Client Error: Too Many Requests
‚ö†Ô∏è Rate limit hit #2 from CoinGecko
...
```

### –ü–æ—Å–ª–µ 5 –æ—à–∏–±–æ–∫:

```
‚ö†Ô∏è Rate limit hit #5 from CoinGecko
üö® CIRCUIT BREAKER –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!
–ü–æ–ª—É—á–µ–Ω–æ 5 –æ—à–∏–±–æ–∫ 429.
–ó–∞–ø—Ä–æ—Å—ã —Ü–µ–Ω –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–æ –∫–æ–Ω—Ü–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞.
```

### –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã:

```
‚ö° Circuit breaker –∞–∫—Ç–∏–≤–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã –¥–ª—è ETH
‚ö° Circuit breaker –∞–∫—Ç–∏–≤–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã –¥–ª—è SOL
‚ö° Circuit breaker –∞–∫—Ç–∏–≤–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã –¥–ª—è DOGE
...
```

### –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–∞—Ä—Å–∏–Ω–≥–µ:

```
üîÑ Circuit breaker —Å–±—Ä–æ—à–µ–Ω
üì° –ó–∞–ø—Ä–æ—Å —Ü–µ–Ω—ã USDT —Å CoinMarketCap...
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–∞

–ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5):

```python
# –í utils/price_fetcher.py
self.rate_limit_threshold = 3  # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Å–ª–µ 3 –æ—à–∏–±–æ–∫
```

–ò–ª–∏ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ:

```python
fetcher = PriceFetcher()
fetcher.rate_limit_threshold = 10  # –ë–æ–ª–µ–µ —Ç–µ—Ä–ø–∏–º—ã–π –ø–æ—Ä–æ–≥
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã)

1. **–ü–æ–ª–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Ü–µ–Ω**:
   - –ü–ª—é—Å—ã: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
   - –ú–∏–Ω—É—Å—ã: –ù–µ—Ç USD —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–æ–≤, —Å–ª–æ–∂–Ω–µ–µ –æ—Ü–µ–Ω–∏—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–µ–π–∫–∏–Ω–≥–∞

2. **–ë–∞—Ç—á-–∑–∞–ø—Ä–æ—Å—ã**:
   - –ü–ª—é—Å—ã: –ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API
   - –ú–∏–Ω—É—Å—ã: CoinGecko Free API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±–∞—Ç—á-–∑–∞–ø—Ä–æ—Å—ã

3. **–ü–ª–∞—Ç–Ω—ã–π API –∫–ª—é—á**:
   - –ü–ª—é—Å—ã: –í—ã—à–µ rate limit
   - –ú–∏–Ω—É—Å—ã: –°—Ç–æ–∏—Ç –¥–µ–Ω–µ–≥

## –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

Circuit breaker —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è:
- ‚úÖ Gate.io
- ‚úÖ Bybit
- ‚úÖ Kucoin
- ‚úÖ OKX

–í—Å–µ –±–∏—Ä–∂–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ `PriceFetcher`.

---

**–ê–≤—Ç–æ—Ä**: Claude Sonnet 4.5
**–î–∞—Ç–∞**: 2026-01-12
**–í–µ—Ä—Å–∏—è**: 1.0
