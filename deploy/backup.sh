#!/bin/bash

# ============================================================================
# –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è –±–µ–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# ============================================================================

set -e

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
BACKUP_DIR="/home/ubuntu/crypto_promo_bot_backups"
DB_FILE="/home/ubuntu/crypto_promo_bot/data/database.db"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/database_$DATE.db"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±–µ–∫–∞–ø–æ–≤
mkdir -p "$BACKUP_DIR"

echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±–µ–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo "   –ò—Å—Ç–æ—á–Ω–∏–∫: $DB_FILE"
echo "   –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: $BACKUP_FILE"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
if [ -f "$DB_FILE" ]; then
    cp "$DB_FILE" "$BACKUP_FILE"

    # –°–∂–∞—Ç–∏–µ –±–µ–∫–∞–ø–∞
    gzip "$BACKUP_FILE"

    echo "‚úÖ –ë–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω: ${BACKUP_FILE}.gz"

    # –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–º–µ—Ä –±–µ–∫–∞–ø–∞
    BACKUP_SIZE=$(du -h "${BACKUP_FILE}.gz" | cut -f1)
    echo "üì¶ –†–∞–∑–º–µ—Ä –±–µ–∫–∞–ø–∞: $BACKUP_SIZE"

    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
    echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±–µ–∫–∞–ø–æ–≤ (>30 –¥–Ω–µ–π)..."
    find "$BACKUP_DIR" -name "database_*.db.gz" -mtime +30 -delete

    # –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –±–µ–∫–∞–ø—ã
    echo ""
    echo "üìÅ –í—Å–µ –±–µ–∫–∞–ø—ã:"
    ls -lh "$BACKUP_DIR"
else
    echo "‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $DB_FILE"
    exit 1
fi
