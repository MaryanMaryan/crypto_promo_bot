#!/bin/bash

# ============================================================================
# –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Crypto Promo Bot –Ω–∞ Oracle Cloud
# ============================================================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∞–ª–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Crypto Promo Bot..."
echo ""

# ============================================================================
# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
# ============================================================================
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
sudo apt update
sudo apt upgrade -y

# ============================================================================
# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
# ============================================================================
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤..."
sudo apt install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    wget \
    curl \
    sqlite3 \
    chromium-browser \
    chromium-chromedriver

# ============================================================================
# 3. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
# ============================================================================
if [ ! -d "/home/ubuntu/crypto_promo_bot" ]; then
    echo "üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
    cd /home/ubuntu
    # –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –†–ï–ü–û–ó–ò–¢–û–†–ò–ô
    # git clone https://github.com/YOUR_USERNAME/crypto_promo_bot.git
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –í–∞–º –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–¥ –±–æ—Ç–∞"
    echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: git clone <–≤–∞—à_—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π>"
else
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# ============================================================================
# 4. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# ============================================================================
echo "üêç –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
cd /home/ubuntu/crypto_promo_bot
python3 -m venv venv

# ============================================================================
# 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# ============================================================================
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# ============================================================================
# 6. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright
# ============================================================================
echo "üåê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤ Playwright..."
playwright install chromium
playwright install-deps chromium

# ============================================================================
# 7. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
# ============================================================================
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
mkdir -p /home/ubuntu/crypto_promo_bot/data
mkdir -p /home/ubuntu/crypto_promo_bot/logs

# ============================================================================
# 8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env —Ñ–∞–π–ª–∞
# ============================================================================
if [ ! -f "/home/ubuntu/crypto_promo_bot/.env" ]; then
    echo "‚öôÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –∏–∑ –ø—Ä–∏–º–µ—Ä–∞..."
    cp .env.example .env
    echo ""
    echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .env –∏ –¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:"
    echo "   nano /home/ubuntu/crypto_promo_bot/.env"
    echo ""
    echo "   –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å:"
    echo "   - BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞"
    echo "   - ADMIN_CHAT_ID=–≤–∞—à_chat_id"
else
    echo "‚úÖ –§–∞–π–ª .env —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# ============================================================================
# 9. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd service
# ============================================================================
echo "‚öôÔ∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd service..."
sudo cp deploy/crypto_promo_bot.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable crypto_promo_bot

echo ""
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª:"
echo "      nano /home/ubuntu/crypto_promo_bot/.env"
echo ""
echo "   2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:"
echo "      sudo systemctl start crypto_promo_bot"
echo ""
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:"
echo "      sudo systemctl status crypto_promo_bot"
echo ""
echo "   4. –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:"
echo "      sudo journalctl -u crypto_promo_bot -f"
echo ""
